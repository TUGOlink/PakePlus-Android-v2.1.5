<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>åå·é©¾è®­ç¦å·æ ¡åŒºåˆ†å¸ƒåœ°å›¾</title>
    <style>
        /* --- æ–°å¢ï¼šç”¨æˆ·ç™»å½•ç•Œé¢æ ·å¼ --- */
        #login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
            transition: opacity 0.5s ease;
        }
        #login-modal .modal-content {
            background-color: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            width: 300px;
            text-align: center;
            transform: translateX(0);
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        #login-modal .modal-content.shake {
            animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both;
        }
        #login-modal h2 {
            margin-top: 0;
            color: #333;
            font-size: 20px;
        }
        #login-modal input[type="text"],
        #login-modal input[type="password"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }
        #login-modal button {
            padding: 12px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #login-modal button:hover {
            background-color: #0056b3;
        }
        #login-error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 15px;
            min-height: 18px;
        }
        /* --- ç”¨æˆ·ç™»å½•ç•Œé¢æ ·å¼ç»“æŸ --- */

        /* æ ¸å¿ƒä¿®æ”¹ï¼šç¦æ­¢é¡µé¢æ•´ä½“æ»šåŠ¨ï¼Œé”å®šå¸ƒå±€ */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            background-color: #f4f7f9; 
            overflow: hidden; /* ç¦æ­¢é¡µé¢æ•´ä½“æ»šåŠ¨ */
        }
        
        /* å¤´éƒ¨å›ºå®šé«˜åº¦ï¼Œé¿å…æŒ¤å‹ */
        #header { 
            padding: 12px 15px; 
            background-color: #ffffff; 
            border-bottom: 1px solid #dee2e6; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 100;
            height: 56px; /* å›ºå®šå¤´éƒ¨é«˜åº¦ */
            box-sizing: border-box;
        }
        
        #header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            max-width: 800px; /* é€‚åº¦æ”¾å®½å¤´éƒ¨æ§ä»¶æœ€å¤§å®½åº¦ï¼Œé¿å…æ‹¥æŒ¤ */
        }

        #togglePanelButton {
            padding: 8px 12px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-left: auto; /* æ ¸å¿ƒä¿®æ”¹ï¼šè‡ªåŠ¨é å·¦å¡«å……ç©ºé—´ï¼Œå°†æŒ‰é’®æ¨åˆ°æœ€å³ä¾§ */
        }
        #togglePanelButton:hover {
            background-color: #5a626e;
        }

        #search-container { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            position: relative;
            flex-grow: 1;
            max-width: 400px; /* é™åˆ¶æœç´¢å®¹å™¨æœ€å¤§å®½åº¦ï¼Œé¿å…å æ»¡ç©ºé—´ */
        }
        #searchInput { 
            padding: 8px 12px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            width: 100%; 
            max-width: 320px; /* é™åˆ¶æœç´¢æ¡†æœ€å¤§å®½åº¦ï¼Œé¿å…æŒ¤å‹ */
            font-size: 14px;
            transition: border-color 0.2s;
            flex-shrink: 1; /* å…è®¸æœç´¢æ¡†é€‚åº¦æ”¶ç¼© */
        }
        #searchInput:focus { 
            outline: none; 
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        #searchButton { 
            padding: 8px 12px; 
            background-color: #007bff; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            flex-shrink: 0; /* ç¦æ­¢æœç´¢æŒ‰é’®æ”¶ç¼© */
            min-width: 40px; /* ä¿è¯æŒ‰é’®æœ€å°å®½åº¦ */
        }
        #searchButton:hover { 
            background-color: #0056b3; 
            transform: scale(1.05);
        }

        /* --- æ¸…é™¤æŒ‰é’®æ ·å¼ --- */
        #clearButton {
            width: 28px;
            height: 28px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
            flex-shrink: 0; /* ç¦æ­¢æ¸…é™¤æŒ‰é’®æ”¶ç¼© */
        }
        #clearButton:hover {
            background-color: #0056b3;
            transform: rotate(90deg);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.4);
        }
        /* --- æ¸…é™¤æŒ‰é’®æ ·å¼ç»“æŸ --- */

        #suggestion-list { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            width: 100%; 
            background-color: white; 
            border: 1px solid #dee2e6; 
            border-radius: 4px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            z-index: 1000;
            display: none;
            max-width: 320px; /* åŒæ­¥é™åˆ¶ä¸‹æ‹‰å»ºè®®åˆ—è¡¨å®½åº¦ */
        }
        #suggestion-list li { 
            padding: 8px 12px; 
            font-size: 14px; 
            border-bottom: 1px solid #f0f0f0; 
            cursor: pointer; 
            transition: background-color 0.2s;
        }
        #suggestion-list li:hover { 
            background-color: #e8f4f8; 
        }
        #suggestion-list li:last-child { 
            border-bottom: none;
        }
        #suggestion-list li .keyword { 
            font-weight: bold; 
            color: #007bff; 
        }
        
        /* æ ¸å¿ƒä¿®æ”¹ï¼šä¸»å®¹å™¨å›ºå®šé«˜åº¦ï¼Œå¡«å……å¤´éƒ¨ä¸‹æ–¹ç©ºé—´ */
        #main-container {
            display: flex;
            flex: none; /* å–æ¶ˆflexè‡ªåŠ¨ä¼¸ç¼© */
            height: calc(100vh - 56px); /* é«˜åº¦ = å±å¹•é«˜åº¦ - å¤´éƒ¨é«˜åº¦ */
            margin: 0;
            border-radius: 0;
            overflow: hidden; /* ç¦æ­¢ä¸»å®¹å™¨æ»šåŠ¨ */
            box-shadow: none;
            position: relative;
        }

        #map-container { 
            display: flex;
            width: 100%;
            height: 100%; /* å¡«æ»¡ä¸»å®¹å™¨ */
            transition: flex 0.3s ease-in-out;
            flex-direction: row; /* åœ°å›¾å·¦ï¼Œç»“æœå³ */
        }
        /* æ ¸å¿ƒä¿®æ”¹ï¼šåœ°å›¾å®¹å™¨å›ºå®šé«˜åº¦ï¼Œç¦æ­¢æ»šåŠ¨ */
        #map { 
            flex: 1;
            height: 100%;
            overflow: hidden; /* åœ°å›¾å†…éƒ¨æ»šè½®åªç¼©æ”¾ï¼Œä¸æ»šåŠ¨ */
            position: relative;
        }
        /* æœç´¢ç»“æœå›ºå®šåœ¨å³ä¾§ */
        #search-results { 
            width: 280px; 
            background-color: white; 
            border-left: 1px solid #eee; 
            padding: 15px; 
            overflow-y: auto; /* ç»“æœé¢æ¿å†…éƒ¨å¯æ»šåŠ¨ */
            display: flex; 
            flex-direction: column; 
            transition: transform 0.3s ease-in-out;
            transform: translateX(0);
            height: 100%; /* å¡«æ»¡ä¸»å®¹å™¨é«˜åº¦ */
            box-sizing: border-box;
        }
        /* æŠ˜å çŠ¶æ€ï¼šå‘å³éšè— */
        #search-results.collapsed { 
            width: 280px;
            transform: translateX(100%);
            padding: 0; 
            border-left: none;
        }
        #search-results h3 { margin: 0 0 15px 0; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 8px; color: #333; }
        
        #custom-results-panel { list-style: none; padding: 0; margin: 0 0 20px 0; flex-grow: 1; }
        #custom-results-panel li { padding: 12px 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background-color 0.2s; }
        #custom-results-panel li:hover { background-color: #e8f4f8; }
        #custom-results-panel li .title { font-weight: bold; font-size: 15px; color: #333; }
        #custom-results-panel li .address { font-size: 13px; color: #6c757d; margin-top: 4px; }

        #recommendation-panel { margin-top: auto; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6; }
        #recommendation-panel h4 { margin: 0 0 12px 0; font-size: 16px; color: #007bff; font-weight: 600; }
        #recommendation-panel ul { margin: 0; padding: 0; list-style: none; font-size: 13px; }
        #recommendation-panel li { 
            margin-bottom: 10px; 
            padding: 10px; 
            border-radius: 6px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 10px;
            background-color: #fff;
            border: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        #recommendation-panel li:last-child { margin-bottom: 0; }
        #recommendation-panel li:hover { 
            background-color: #e8f4f8; 
            border-color: #b8daff;
            transform: translateX(3px);
        }
        #recommendation-panel li .type-tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: white;
            white-space: nowrap;
        }
        #recommendation-panel li .school-info { flex-grow: 1; }
        #recommendation-panel li .school-info .name { font-weight: bold; color: #333; }
        #recommendation-panel li .distance { font-size: 12px; color: #6c757d; }

        /* --- åœ°å›¾ç¼©æ”¾æ§ä»¶æ ·å¼ --- */
        .BMap_noprint {
            z-index: 10 !important;
        }
        .BMap_noprint .BMap_zoomCtrl {
            border: none !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        .BMap_noprint .BMap_zoomCtrl button {
            background-color: #ffffff !important;
            border: none !important;
            width: 32px !important;
            height: 32px !important;
            font-size: 20px !important;
            color: #333 !important;
            transition: all 0.2s ease !important;
        }
        .BMap_noprint .BMap_zoomCtrl button:hover {
            background-color: #007bff !important;
            color: #ffffff !important;
        }
        .BMap_noprint .BMap_zoomCtrl button.BMap_zoomIn {
            border-bottom: 1px solid #f0f0f0 !important;
        }
        /* --- åœ°å›¾ç¼©æ”¾æ§ä»¶æ ·å¼ç»“æŸ --- */
        
        /* --- åŠ è½½å’Œé”™è¯¯çŠ¶æ€æ ·å¼ --- */
        #map-status {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(244, 247, 249, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            font-size: 16px;
            color: #333;
        }
        #map-status.error {
            color: #dc3545;
        }
        #map-status i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #007bff;
        }
        #map-status.error i {
            color: #dc3545;
        }
        /* --- åŠ è½½å’Œé”™è¯¯çŠ¶æ€æ ·å¼ç»“æŸ --- */

        /* --- ç§»åŠ¨ç«¯é€‚é…ï¼šåº•éƒ¨å¯¼èˆªæ  --- */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 8px 0 16px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            height: 60px; /* å›ºå®šåº•éƒ¨å¯¼èˆªé«˜åº¦ */
            box-sizing: border-box;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #6c757d;
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item .icon {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .nav-item:hover, .nav-item.active {
            color: #007bff;
        }
        /* --- åº•éƒ¨å¯¼èˆªæ ç»“æŸ --- */

        /* --- ç§»åŠ¨ç«¯é€‚é…ï¼šæ¨¡æ€æ¡† --- */
        .modal {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 80vh;
            background-color: #ffffff;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal.active {
            transform: translateY(0);
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 18px;
            color: #333;
        }
        
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 0;
            line-height: 1;
        }

        .modal-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        /* --- æ¨¡æ€æ¡†æ ·å¼ç»“æŸ --- */

        /* --- èŠå¤©çª—å£æ ·å¼ --- */
        #chat-window.modal .modal-content {
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        #chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        
        .message {
            margin-bottom: 15px;
            max-width: 80%;
        }
        
        .user-message {
            align-self: flex-end;
            margin-left: auto;
        }
        
        .ai-message {
            align-self: flex-start;
        }
        
        .message-content {
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 14px;
            word-wrap: break-word;
        }
        
        .user-message .message-content {
            background-color: #007bff;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .ai-message .message-content {
            background-color: #e9ecef;
            color: #333;
            border-bottom-left-radius: 4px;
        }
        
        .message-time {
            font-size: 11px;
            color: #6c757d;
            margin-top: 5px;
            text-align: right;
        }
        
        #chat-input-area {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 10px;
        }
        
        #chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        
        #chat-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        #chat-send-btn {
            width: 40px;
            height: 40px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        #chat-send-btn:hover {
            background-color: #0056b3;
        }
        /* --- èŠå¤©çª—å£æ ·å¼ç»“æŸ --- */

        /* --- æ–‡æ¡£ã€ä»·æ ¼ã€å…¬å‘Šã€æ›´æ–°é¢æ¿æ ·å¼ --- */
        .doc-section, .price-section, .announcement-section {
            margin-bottom: 20px;
        }    
        .doc-section:last-child, .price-section:last-child, .announcement-section:last-child {
            margin-bottom: 0;
        }

        .doc-section h3, .price-section h3, .announcement-section h3, #update-info h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
            display: inline-block;
            font-weight: 600;
        }

        .announcement-section h3 {
            color: #d9534f;
            border-bottom-color: #d9534f;
        }

        .announcement-section p, #update-info p {
            font-size: 15px;
            color: #333;
            margin-bottom: 15px;
        }

        .info-table, .price-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            text-align: left;
            table-layout: fixed;
            margin-bottom: 15px;
        }

        .info-table th, .info-table td, .price-table th, .price-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
            word-wrap: break-word;
            word-break: break-all;
        }

        .info-table th, .price-table th {
            background-color: #e8f4f8;
            font-weight: 600;
            color: #007bff;
        }
        
        .info-table tr:hover, .price-table tr:hover {
            background-color: #f8f9fa;
        }

        .info-table .highlight, .price-table .price-highlight {
            color: #007bff;
            font-weight: bold;
            text-align: center;
        }

        .price-table .price-highlight {
            color: #dc3545;
        }
        
        #update-info button {
            padding: 12px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin: 10px 0;
            text-decoration: none;
            display: inline-block;
        }
        
        #update-info button:hover {
            background-color: #0056b3;
        }
        
        #update-info img {
            margin-top: 15px;
            border: 1px solid #eee;
            padding: 5px;
            background: #fff;
            max-width: 100%;
            height: auto;
        }
        
        /* --- æ»šåŠ¨æ¡ç¾åŒ– --- */
        #chat-messages::-webkit-scrollbar,
        .modal-content::-webkit-scrollbar,
        #search-results::-webkit-scrollbar {
            width: 6px;
        }
        
        #chat-messages::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track,
        #search-results::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        #chat-messages::-webkit-scrollbar-thumb,
        .modal-content::-webkit-scrollbar-thumb,
        #search-results::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        
        #chat-messages::-webkit-scrollbar-thumb:hover,
        .modal-content::-webkit-scrollbar-thumb:hover,
        #search-results::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* --- å“åº”å¼å¸ƒå±€ï¼šç§»åŠ¨ç«¯é€‚é… --- */
        @media (max-width: 768px) {
            /* ç§»åŠ¨ç«¯ä¸»å®¹å™¨é«˜åº¦ = å±å¹•é«˜åº¦ - å¤´éƒ¨ - åº•éƒ¨å¯¼èˆª */
            #main-container {
                height: calc(100vh - 56px - 60px);
            }
            #map-container {
                position: relative;
            }
            #search-results {
                position: absolute;
                top: 0;
                right: 0;
                height: 100%;
                width: 280px;
                background-color: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(5px);
                z-index: 90;
                border-left: 1px solid #eee;
            }
            #search-results.collapsed {
                transform: translateX(100%);
            }
            #togglePanelButton {
                display: block;
            }
            /* ç§»åŠ¨ç«¯é€‚é…æœç´¢æ¡†å®½åº¦ */
            #search-container {
                max-width: 220px;
            }
            #searchInput {
                max-width: 180px;
            }
            #suggestion-list {
                max-width: 180px;
            }
        }
    </style>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=3tGC1P3gdnXKMXg05vFRWt1ad4Dp6ZU2"></script>
</head>
<body>
    <!-- --- ç”¨æˆ·ç™»å½•ç•Œé¢ HTML --- -->
    <div id="login-modal">
        <div class="modal-content">
            <h2>ç”¨æˆ·ç™»å½•</h2>
            <input type="text" id="username-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" autocomplete="username">
            <input type="password" id="password-input" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="current-password">
            <button onclick="checkLogin()">ç™»å½•</button>
            <div id="login-error"></div>
        </div>
    </div>
    <!-- --- ç”¨æˆ·ç™»å½•ç•Œé¢ HTML ç»“æŸ --- -->

    <div id="header">
        <div id="header-controls">
            <div id="search-container">
                <input type="text" id="searchInput" placeholder="æœç´¢ç¦å·ä»»æ„ä½ç½®...">
                <button id="clearButton" onclick="clearSearch()" title="æ¸…é™¤">Ã—</button>
                <ul id="suggestion-list"></ul>
            </div>
            <button id="searchButton" onclick="searchLocation()">æœ</button>
            <button id="togglePanelButton" title="åˆ‡æ¢åˆ—è¡¨">â˜°</button>
        </div>
    </div>

    <div id="main-container">
        <div id="map-container">
            <div id="map">
                <div id="map-status">
                    <i>â³</i>
                    <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
                </div>
            </div>
            <div id="search-results" class="collapsed">
                <h3>æœç´¢ç»“æœ</h3>
                <ul id="custom-results-panel"></ul>
                <div id="recommendation-panel"></div>
            </div>
        </div>
    </div>

    <!-- --- ç§»åŠ¨ç«¯é€‚é…ï¼šåº•éƒ¨å¯¼èˆªæ  --- -->
    <nav id="bottom-nav">
        <div class="nav-item" onclick="toggleAnnouncementWidget()">
            <div class="icon">ğŸ””</div>
            <div class="label">å…¬å‘Š</div>
        </div>
        <div class="nav-item" onclick="togglePriceWidget()">
            <div class="icon">ğŸ’°</div>
            <div class="label">ä»·æ ¼</div>
        </div>
        <div class="nav-item" onclick="toggleDocWidget()">
            <div class="icon">ğŸš–</div>
            <div class="label">é©¾è€ƒ</div>
        </div>
        <div class="nav-item" onclick="toggleChatWindow()">
            <div class="icon">ğŸ‘©â€ğŸ’¼</div>
            <div class="label">AI</div>
        </div>
        <div class="nav-item" onclick="toggleUpdateWidget()">
            <div class="icon">ğŸ’</div>
            <div class="label">æ›´æ–°</div>
        </div>
    </nav>
    <!-- --- åº•éƒ¨å¯¼èˆªæ ç»“æŸ --- -->

    <!-- --- ç§»åŠ¨ç«¯é€‚é…ï¼šå…¬å‘Šæ¨¡æ€æ¡† --- -->
    <div id="announcement-modal" class="modal">
        <div class="modal-header">
            å…¬å‘Š
            <button class="modal-close-btn" onclick="closeAnnouncementModal()">Ã—</button>
        </div>
        <div class="modal-content" id="announcement-panel-content">
            <!-- å†…å®¹ç”±JSåŠ¨æ€å¡«å…… -->
        </div>
    </div>

    <!-- --- ç§»åŠ¨ç«¯é€‚é…ï¼šä»·æ ¼æ¨¡æ€æ¡† --- -->
    <div id="price-modal" class="modal">
        <div class="modal-header">
            ä»·æ ¼è¡¨
            <button class="modal-close-btn" onclick="closePriceModal()">Ã—</button>
        </div>
        <div class="modal-content" id="price-panel-content">
            <!-- å†…å®¹ç”±JSåŠ¨æ€å¡«å…… -->
        </div>
    </div>

    <!-- --- ç§»åŠ¨ç«¯é€‚é…ï¼šæ–‡æ¡£æ¨¡æ€æ¡† --- -->
    <div id="doc-modal" class="modal">
        <div class="modal-header">
            è´¹ç”¨ä¸å­¦æ—¶æ˜ç»†
            <button class="modal-close-btn" onclick="closeDocModal()">Ã—</button>
        </div>
        <div class="modal-content" id="doc-panel-content">
            <!-- å†…å®¹ç”±JSåŠ¨æ€å¡«å…… -->
        </div>
    </div>

    <!-- --- ç§»åŠ¨ç«¯é€‚é…ï¼šèŠå¤©æ¨¡æ€æ¡† --- -->
    <div id="chat-window" class="modal">
        <div class="modal-header">
            æ™ºèƒ½åŠ©æ‰‹
            <button class="modal-close-btn" onclick="closeChatModal()">Ã—</button>
        </div>
        <div class="modal-content">
            <div id="chat-messages">
                <div class="message ai-message">
                    <div class="message-content">ä½ å¥½ï¼æˆ‘æ˜¯åå·é©¾è®­çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ</div>
                    <div class="message-time">åˆšåˆš</div>
                </div>
            </div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button id="chat-send-btn">â†’</button>
            </div>
        </div>
    </div>

    <!-- --- ç§»åŠ¨ç«¯é€‚é…ï¼šæ›´æ–°æ¨¡æ€æ¡† --- -->
    <div id="update-modal" class="modal">
        <div class="modal-header">
            æ£€æŸ¥æ›´æ–°
            <button class="modal-close-btn" onclick="closeUpdateModal()">Ã—</button>
        </div>
        <div class="modal-content">
            <div id="update-info">
                <!-- ç‰ˆæœ¬ä¿¡æ¯å’Œä¸‹è½½æŒ‰é’®å°†ç”±JSåŠ¨æ€å¡«å…… -->
            </div>
        </div>
    </div>
    <!-- --- æ¨¡æ€æ¡†ç»“æŸ --- -->
    
    <script type="text/javascript">
        // --- å…¨å±€å˜é‡ ---
        var map, localSearch, ac;
        var appConfig = {};
        var mapInitialCenter = new BMap.Point(119.306239, 26.087438);
        var mapInitialZoom = 13;
        var isResultsPanelVisible = false;
        var currentSearchMarker = null;
        var currentSearchResultsData = [];
        var currentAppVersion = "1.3.0";

        // --- ç§»åŠ¨ç«¯é€‚é…ï¼šæ¨¡æ€æ¡†åˆ‡æ¢é€»è¾‘ ---
        function toggleAnnouncementWidget() {
            const modal = document.getElementById('announcement-modal');
            modal.classList.toggle('active');
            toggleMapScroll(modal.classList.contains('active'));
        }
        function closeAnnouncementModal() {
            document.getElementById('announcement-modal').classList.remove('active');
            toggleMapScroll(false);
        }

        function togglePriceWidget() {
            const modal = document.getElementById('price-modal');
            modal.classList.toggle('active');
            toggleMapScroll(modal.classList.contains('active'));
        }
        function closePriceModal() {
            document.getElementById('price-modal').classList.remove('active');
            toggleMapScroll(false);
        }

        function toggleDocWidget() {
            const modal = document.getElementById('doc-modal');
            modal.classList.toggle('active');
            toggleMapScroll(modal.classList.contains('active'));
        }
        function closeDocModal() {
            document.getElementById('doc-modal').classList.remove('active');
            toggleMapScroll(false);
        }

        function toggleChatWindow() {
            const modal = document.getElementById('chat-window');
            modal.classList.toggle('active');
            toggleMapScroll(modal.classList.contains('active'));
        }
        function closeChatModal() {
            document.getElementById('chat-window').classList.remove('active');
            toggleMapScroll(false);
        }

        function toggleUpdateWidget() {
            const modal = document.getElementById('update-modal');
            modal.classList.toggle('active');
            toggleMapScroll(modal.classList.contains('active'));
            if (modal.classList.contains('active')) {
                checkForUpdates();
            }
        }
        function closeUpdateModal() {
            document.getElementById('update-modal').classList.remove('active');
            toggleMapScroll(false);
        }

        // å½“æ¨¡æ€æ¡†æ‰“å¼€æ—¶ï¼Œç¦æ­¢åœ°å›¾æ»šåŠ¨ï¼Œåä¹‹åˆ™å…è®¸
        function toggleMapScroll(disable) {
            if (map) {
                map.enableScrollWheelZoom(!disable);
            }
            document.body.style.overflow = disable ? 'hidden' : 'auto';
        }
        // --- æ¨¡æ€æ¡†åˆ‡æ¢é€»è¾‘ç»“æŸ ---

        // --- ç‰ˆæœ¬å·æ¯”è¾ƒå‡½æ•° ---
        function compareVersions(v1, v2) {
            const v1Parts = v1.split('.').map(Number);
            const v2Parts = v2.split('.').map(Number);
            for (let i = 0; i < Math.max(v1Parts.length, v2Parts.length); i++) {
                const num1 = v1Parts[i] || 0;
                const num2 = v2Parts[i] || 0;
                if (num1 > num2) return 1;
                if (num1 < num2) return -1;
            }
            return 0;
        }

        // --- æ£€æŸ¥æ›´æ–°çš„æ ¸å¿ƒé€»è¾‘ ---
        function checkForUpdates() {
            const updateInfoDiv = document.getElementById('update-info');
            if (!appConfig || !appConfig.appVersion) {
                updateInfoDiv.innerHTML = `<h3>ç‰ˆæœ¬æ›´æ–°</h3><p style="color: #dc3545; font-weight: bold;">æ£€æŸ¥æ›´æ–°å¤±è´¥ï¼Œæ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯ã€‚</p>`;
                return;
            }
            const latestVersion = appConfig.appVersion;
            const comparisonResult = compareVersions(currentAppVersion, latestVersion);
            let htmlContent = `<h3>ç‰ˆæœ¬æ›´æ–°</h3>`;
            htmlContent += `<p><strong>å½“å‰ç‰ˆæœ¬:</strong> ${currentAppVersion}</p>`;
            htmlContent += `<p><strong>æœ€æ–°ç‰ˆæœ¬:</strong> ${latestVersion}</p>`;
            if (comparisonResult === -1) {
                htmlContent += `<p style="color: #dc3545; font-weight: bold;">å‘ç°æ–°ç‰ˆæœ¬ï¼å»ºè®®ç«‹å³æ›´æ–°ã€‚</p>`;
                htmlContent += `<div style="margin-top: 20px;">`;
                if (appConfig.downloadLinks && appConfig.downloadLinks.windows) {
                    htmlContent += `<a href="${appConfig.downloadLinks.windows}" target="_blank" download><button>ğŸ–¥ï¸ Windows ä¸‹è½½</button></a>`;
                }
                if (appConfig.downloadLinks && appConfig.downloadLinks.androidQrCode) {
                    htmlContent += `<div style="margin-top: 15px;"><p style="font-size: 12px; color: #6c757d; margin-bottom: 5px;">ğŸ“± å®‰å“æ‰«ç ä¸‹è½½</p><img src="${appConfig.downloadLinks.androidQrCode}" alt="å®‰å“ä¸‹è½½äºŒç»´ç " style="width: 120px; height: 120px; border-radius: 5px;"></div>`;
                }
                htmlContent += `</div>`;
            } else if (comparisonResult === 0) {
                htmlContent += `<p style="color: #28a745; font-weight: bold;">æ­å–œï¼Œå·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼</p>`;
            } else {
                htmlContent += `<p style="color: #ffc107; font-weight: bold;">æ‚¨çš„ç‰ˆæœ¬æ¯”çº¿ä¸Šç‰ˆæœ¬æ–°ã€‚</p>`;
            }
            updateInfoDiv.innerHTML = htmlContent;
        }

        // --- åŠ¨æ€æ¸²æŸ“å…¬å‘Šé¢æ¿å†…å®¹ ---
        function renderAnnouncementPanelContent(config) {
            const panelContent = document.getElementById('announcement-panel-content');
            if (config.announcement && config.announcement.title && config.announcement.content) {
                panelContent.innerHTML = `<div class="announcement-section"><h3>${config.announcement.title}</h3><p>${config.announcement.content}</p></div>`;
            } else {
                panelContent.innerHTML = '<p style="text-align: center; color: #6c757d; margin-top: 20px;">å½“å‰æ²¡æœ‰å…¬å‘Šã€‚</p>';
            }
        }

        // --- åŠ¨æ€æ¸²æŸ“æ–‡æ¡£é¢æ¿å†…å®¹ ---
        function renderDocPanelContent(config) {
            const docPanelContent = document.getElementById('doc-panel-content');
            docPanelContent.innerHTML = '';
            const feeSection = document.createElement('div');
            feeSection.className = 'doc-section';
            feeSection.innerHTML = `<h3>C1/C2 è€ƒè¯•è´¹ç”¨æ˜ç»†</h3><table class="info-table"><thead><tr><th>é¡¹ç›®</th><th>è´¹ç”¨</th><th>è¯¦æƒ…</th></tr></thead><tbody></tbody></table>`;
            const feeTableBody = feeSection.querySelector('tbody');
            config.examFees.forEach(item => feeTableBody.innerHTML += `<tr><td>${item.project}</td><td class="highlight">${item.cost}</td><td>${item.details}</td></tr>`);
            docPanelContent.appendChild(feeSection);
            const hourSection = document.createElement('div');
            hourSection.className = 'doc-section';
            hourSection.innerHTML = `<h3>C1/C2 å­¦æ—¶æ˜ç»†</h3><table class="info-table"><thead><tr><th>ç§‘ç›®</th><th>å†…å®¹</th><th>C1 å­¦æ—¶</th><th>C2 å­¦æ—¶</th></tr></thead><tbody></tbody></table>`;
            const hourTableBody = hourSection.querySelector('tbody');
            config.examHours.forEach(item => hourTableBody.innerHTML += `<tr><td>${item.subject}</td><td>${item.content}</td><td class="highlight">${item.c1Hours}</td><td class="highlight">${item.c2Hours}</td></tr>`);
            docPanelContent.appendChild(hourSection);
        }

        // --- åŠ¨æ€æ¸²æŸ“ä»·æ ¼é¢æ¿å†…å®¹ ---
        function renderPricePanelContent(config) {
            const pricePanelContent = document.getElementById('price-panel-content');
            pricePanelContent.innerHTML = '';
            const selfOperatedSection = document.createElement('div');
            selfOperatedSection.className = 'price-section';
            selfOperatedSection.innerHTML = `<h3>è‡ªè¥æ ¡åŒºæŠ¥ä»·</h3><table class="price-table"><thead><tr><th>ç­å‹</th><th>ç¤¾ä¼šç”Ÿ</th><th>å­¦ç”Ÿ</th></tr></thead><tbody></tbody></table>`;
            const selfOperatedTableBody = selfOperatedSection.querySelector('tbody');
            config.prices.selfOperated.forEach(item => selfOperatedTableBody.innerHTML += `<tr><td>${item.classType}</td><td class="price-highlight">${item.socialPrice}</td><td class="price-highlight">${item.studentPrice}</td></tr>`);
            pricePanelContent.appendChild(selfOperatedSection);
            const cooperativeSection = document.createElement('div');
            cooperativeSection.className = 'price-section';
            cooperativeSection.innerHTML = `<h3>åˆä½œæ ¡åŒºæŠ¥ä»·</h3><table class="price-table"><thead><tr><th>ç­å‹</th><th>ç¤¾ä¼šç”Ÿ</th><th>å­¦ç”Ÿ</th></tr></thead><tbody></tbody></table>`;
            const cooperativeTableBody = cooperativeSection.querySelector('tbody');
            config.prices.cooperative.forEach(item => cooperativeTableBody.innerHTML += `<tr><td>${item.classType}</td><td class="price-highlight">${item.socialPrice}</td><td class="price-highlight">${item.studentPrice}</td></tr>`);
            pricePanelContent.appendChild(cooperativeSection);
        }

        function initMap() {
            const mapStatusDiv = document.getElementById('map-status');
            const configUrl = 'https://gitee.com/pjyaoo/hcjx-config/raw/master/config.json';
            fetch(configUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`ç½‘ç»œå“åº”é”™è¯¯: ${response.statusText}`);
                    return response.json();
                })
                .then(config => {
                    appConfig = config;
                    mapStatusDiv.style.display = 'none';
                    renderAnnouncementPanelContent(config);
                    renderDocPanelContent(config);
                    renderPricePanelContent(config);
                    map = new BMap.Map("map");
                    map.centerAndZoom(mapInitialCenter, mapInitialZoom);
                    map.enableScrollWheelZoom(true);
                    map.addControl(new BMap.NavigationControl({type: BMAP_NAVIGATION_CONTROL_SMALL}));
                    map.addControl(new BMap.ScaleControl());
                    loadPresetDrivingSchools(config.drivingSchools);
                    localSearch = new BMap.LocalSearch(map, {
                        renderOptions: { map: map },
                        onSearchComplete: function(results) {
                            if (localSearch.getStatus() === BMAP_STATUS_SUCCESS) {
                                currentSearchResultsData = [];
                                const maxCount = results.getCurrentNumPois();
                                for (let i = 0; i < maxCount; i++) currentSearchResultsData.push(results.getPoi(i));
                                renderCustomResultsList();
                                toggleResultsPanel(true);
                            }
                        }
                    });
                    ac = new BMap.Autocomplete({"input": "searchInput", "location": map});
                    ac.addEventListener("onconfirm", searchLocation);
                    document.getElementById('togglePanelButton').addEventListener('click', toggleResultsPanel);
                    const loginModal = document.getElementById('login-modal');
                    loginModal.style.display = 'flex';
                    document.getElementById('username-input').focus();
                })
                .catch(error => {
                    console.error("åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥:", error);
                    mapStatusDiv.className = 'error';
                    mapStatusDiv.innerHTML = `<i>âŒ</i><p>æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚</p><p style="font-size: 12px; margin-top: 10px;">${error.message}</p>`;
                });
        }

        // ä¿®å¤åçš„ toggleResultsPanel å‡½æ•°
        function toggleResultsPanel(forceShow) {
            const resultsPanel = document.getElementById('search-results');
            const toggleButton = document.getElementById('togglePanelButton');
            if (typeof forceShow === 'boolean') {
                isResultsPanelVisible = forceShow;
            } else {
                isResultsPanelVisible = !isResultsPanelVisible;
            }
            if (isResultsPanelVisible) {
                resultsPanel.classList.remove('collapsed');
                toggleButton.textContent = 'âœ•';
                toggleButton.title = 'å…³é—­åˆ—è¡¨';
            } else {
                resultsPanel.classList.add('collapsed');
                toggleButton.textContent = 'â˜°';
                toggleButton.title = 'æ‰“å¼€åˆ—è¡¨';
            }
            if (map && window.innerWidth <= 768) {
                map.checkResize();
            }
        }

        function showSuggestionList(suggestions) {
            const list = document.getElementById("suggestion-list");
            list.innerHTML = "";
            if (suggestions.length === 0) {
                list.style.display = "none";
                return;
            }
            suggestions.forEach(suggestion => {
                const li = document.createElement("li");
                li.innerHTML = suggestion.value.replace(new RegExp(suggestion.key, "gi"), `<span class="keyword">$&</span>`);
                li.onclick = function() {
                    document.getElementById("searchInput").value = suggestion.value;
                    list.style.display = "none";
                };
                list.appendChild(li);
            });
            list.style.display = "block";
        }
        function hideSuggestionList() { document.getElementById("suggestion-list").style.display = "none"; }

        function loadPresetDrivingSchools(schoolsData) {
            schoolsData.forEach(school => {
                const point = new BMap.Point(school.point.lng, school.point.lat);
                addMarker({...school, point: point});
            });
        }

        function addMarker(school) {
            var marker = new BMap.Marker(school.point);
            map.addOverlay(marker);
            var typeColor = school.type === "è‡ªè¥" ? "#28a745" : "#007bff";
            var labelContent = `<div style="display:flex;align-items:center;gap:5px;"><span style="font-size:12px;font-weight:bold;">${school.name}</span><span style="background:${typeColor};color:white;padding:1px 6px;border-radius:3px;font-size:10px;">${school.type}</span></div>`;
            var label = new BMap.Label(labelContent, { offset: new BMap.Size(25, -30) });
            label.setStyle({ borderColor: "#ccc", borderRadius: "3px", backgroundColor: "rgba(255,255,255,0.9)", padding: "5px", boxShadow: "0 2px 5px rgba(0,0,0,0.2)" });
            marker.setLabel(label);
            var infoContent = `<h3 style='margin:0 0 5px 0;font-size:14px;'>${school.name}</h3><p style='margin:0;font-size:12px;line-height:1.5;'>${school.address}</p><p style='margin:5px 0 0 0;font-size:12px;color:#666;'>ç±»å‹ï¼š<strong style='color:${typeColor}'>${school.type}</strong></p>`;
            var infoWindow = new BMap.InfoWindow(infoContent);
            marker.addEventListener("click", function () { this.openInfoWindow(infoWindow); });
        }

        function searchLocation() {
            var keyword = document.getElementById('searchInput').value.trim();
            if (!keyword) { alert("è¯·è¾“å…¥æœç´¢å†…å®¹ï¼"); return; }
            clearSearchVisuals();
            localSearch.search(keyword);
            hideSuggestionList();
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            clearSearchVisuals();
            clearAllCustomMarkers();
            map.centerAndZoom(mapInitialCenter, mapInitialZoom);
            toggleResultsPanel(false);
        }

        function clearSearchVisuals() {
            document.getElementById('custom-results-panel').innerHTML = '';
            document.getElementById('recommendation-panel').innerHTML = '';
            currentSearchResultsData = [];
            if (localSearch) localSearch.clearResults();
            hideSuggestionList();
        } 

        // ä¿®æ­£åçš„clearAllCustomMarkerså‡½æ•°
        function clearAllCustomMarkers() {
            if (currentSearchMarker) {
                map.removeOverlay(currentSearchMarker);
                currentSearchMarker = null;
            }
            map.closeInfoWindow();
        }

        // æ­£ç¡®çš„updateSearchMarkerå‡½æ•°
        function updateSearchMarker(point, title) {
            if (currentSearchMarker) map.removeOverlay(currentSearchMarker);
            var myIcon = new BMap.Icon("https://api.map.baidu.com/images/marker_red.png", new BMap.Size(23, 25), {
                offset: new BMap.Size(10, 25),
                imageOffset: new BMap.Size(0, 0 - 10 * 25)
            });
            currentSearchMarker = new BMap.Marker(point, {icon: myIcon});
            map.addOverlay(currentSearchMarker);
            var label = new BMap.Label(title, { offset: new BMap.Size(25, -30) });
            label.setStyle({ borderColor: "#ff4444", borderRadius: "3px", backgroundColor: "rgba(255,255,255,0.9)", padding: "5px", boxShadow: "0 2px 5px rgba(0,0,0,0.2)", color: "#ff4444", fontWeight: "bold" });
            currentSearchMarker.setLabel(label);
        }

        function updateSchoolMarker(point, school) {
            map.centerAndZoom(point, 17);
            const existingMarker = findExistingMarker(school.name);
            if (existingMarker) setTimeout(() => existingMarker.openInfoWindow(existingMarker.getInfoWindow()), 100);
        }

        function findExistingMarker(schoolName) {
            const overlays = map.getOverlays();
            for (let i = 0; i < overlays.length; i++) {
                const overlay = overlays[i];
                if (overlay instanceof BMap.Marker) {
                    const label = overlay.getLabel();
                    if (label && label.getContent().includes(schoolName)) return overlay;
                }
            }
            return null;
        }

        // åªå±•ç¤ºå‰5æ¡æœç´¢ç»“æœ
        function renderCustomResultsList() {
            const panel = document.getElementById('custom-results-panel');
            panel.innerHTML = '';
            if (currentSearchResultsData.length === 0) {
                panel.innerHTML = '<li style="text-align: center; color: #999; padding: 20px 0;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç»“æœ</li>';
                return;
            }
            currentSearchResultsData.slice(0,5).forEach((poi, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<div class="title">${poi.title}</div><div class="address">${poi.address || 'åœ°å€ä¸è¯¦'}</div>`;
                li.dataset.poiIndex = index;
                li.addEventListener('click', function() {
                    const clickedPoi = currentSearchResultsData[this.dataset.poiIndex];
                    clearAllCustomMarkers();
                    updateSearchMarker(clickedPoi.point, clickedPoi.title);
                    map.centerAndZoom(clickedPoi.point, 16);
                    updateRecommendations(clickedPoi.point);
                });
                panel.appendChild(li);
            });
        }

        function updateRecommendations(targetPoint) {
            if (!targetPoint || !appConfig.drivingSchools) {
                document.getElementById('recommendation-panel').innerHTML = '';
                return;
            }    
            var recommendations = [...appConfig.drivingSchools]
                .map(school => {
                    const point = new BMap.Point(school.point.lng, school.point.lat);
                    school.distance = getDistance(targetPoint, point);
                    return school;
                })
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 5);
            const panel = document.getElementById('recommendation-panel');
            panel.innerHTML = '<h4>ä¸ºæ‚¨æ¨èé™„è¿‘çš„æ ¡åŒºï¼š</h4><ul id="recommendation-list"></ul>';
            const list = panel.querySelector('#recommendation-list');
            if (recommendations.length > 0) {
                recommendations.forEach(school => {
                    const li = document.createElement('li');
                    const typeColor = school.type === "è‡ªè¥" ? "#28a745" : "#007bff";
                    const distanceText = school.distance < 1 ? (school.distance * 1000).toFixed(0) + "ç±³" : school.distance.toFixed(2) + "å…¬é‡Œ";
                    li.innerHTML = `<span class="type-tag" style="background-color: ${typeColor};">${school.type}</span><div class="school-info"><div class="name">${school.name}</div></div><span class="distance">${distanceText}</span>`;
                    li.dataset.schoolData = JSON.stringify(school);
                    li.addEventListener('click', function() {
                        const schoolData = JSON.parse(this.dataset.schoolData);
                        const point = new BMap.Point(schoolData.point.lng, schoolData.point.lat);
                        updateSchoolMarker(point, schoolData);
                        toggleResultsPanel(false);
                    });
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = '<li style="text-align: center; padding: 20px; color: #6c757d;">é™„è¿‘æ²¡æœ‰æ‰¾åˆ°é¢„è®¾çš„é©¾æ ¡ã€‚</li>';
            }
        } 

        function getDistance(point1, point2) {
            var radLat1 = point1.lat * Math.PI / 180.0;
            var radLat2 = point2.lat * Math.PI / 180.0;
            var a = radLat1 - radLat2;
            var b = point1.lng * Math.PI / 180.0 - point2.lng * Math.PI / 180.0;
            var s = 2 * Math.asin(Math.sqrt(Math.pow(Math.sin(a / 2), 2) + Math.cos(radLat1) * Math.cos(radLat2) * Math.pow(Math.sin(b / 2), 2)));
            return s * 6378.137;
        }

        // --- èŠå¤©çª—å£å‘é€æ¶ˆæ¯é€»è¾‘ ---
        (function() {
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            const chatMessages = document.getElementById('chat-messages');

            async function sendMessageToApi() {
                const userMessage = chatInput.value.trim();
                if (!userMessage) return;
                addMessage(userMessage, true);
                chatInput.value = '';
                const thinkingId = 'thinking-' + Date.now();
                const thinkingDiv = document.createElement('div');
                thinkingDiv.id = thinkingId;
                thinkingDiv.className = 'message ai-message';
                thinkingDiv.innerHTML = `<div class="message-content">æ­£åœ¨æ€è€ƒä¸­...</div><div class="message-time">åˆšåˆš</div>`;
                chatMessages.appendChild(thinkingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                try {
                    const payload = {
                        "model": "Qwen/Qwen2-7B-Instruct",
                        "messages": [
                            { "role": "system", "content": "ä½ æ˜¯åå·é©¾è®­çš„æ™ºèƒ½å®¢æœåŠ©æ‰‹ï¼Œåä¸ºåå°å·ã€‚ä½ åº”è¯¥ç”¨ä¸“ä¸šã€å‹å¥½ã€ä¹äºåŠ©äººçš„æ€åº¦å›ç­”ç”¨æˆ·å…³äºåå·é©¾è®­ç¦å·æ ¡åŒºçš„ä»»ä½•é—®é¢˜ã€‚å¦‚æœç”¨æˆ·çš„é—®é¢˜ä¸é©¾æ ¡æ— å…³ï¼Œä½ å¯ä»¥ç¤¼è²Œåœ°å¼•å¯¼ä»–ä»¬å›åˆ°é©¾æ ¡è¯é¢˜ã€‚" },
                            { "role": "user", "content": userMessage }
                        ],
                        "stream": true, "temperature": 0.7, "max_tokens": 1024
                    };
                    const response = await fetch("https://api.siliconflow.cn/v1/chat/completions", {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer sk-ispnknefahezdobxmguouiqvogbzeycgcrilruqgiwwqdlna` }, body: JSON.stringify(payload)
                    });    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: 'æ— æ³•è§£æé”™è¯¯ä¿¡æ¯' }));
                        throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.statusText} - ${errorData.message || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullText = '';
                    let aiMessageDiv = null;
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) {
                            if (!aiMessageDiv) {
                                document.getElementById(thinkingId).remove();
                                addMessage("è¯·æ±‚å·²å®Œæˆï¼Œä½†æœªæ”¶åˆ°å›å¤ã€‚", false);
                            }
                            break;
                        }
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n').filter(line => line.trim() !== '');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6);
                                if (data === '[DONE]') continue;
                                try {
                                    const parsed = JSON.parse(data);
                                    if (parsed.choices && parsed.choices[0].delta.content) {
                                        const content = parsed.choices[0].delta.content;
                                        fullText += content;
                                        if (!aiMessageDiv) {
                                            document.getElementById(thinkingId).remove();
                                            aiMessageDiv = document.createElement('div');
                                            aiMessageDiv.className = 'message ai-message';
                                            aiMessageDiv.innerHTML = `<div class="message-content"></div><div class="message-time">åˆšåˆš</div>`;
                                            chatMessages.appendChild(aiMessageDiv);
                                        }
                                        aiMessageDiv.querySelector('.message-content').innerHTML = fullText;
                                        chatMessages.scrollTop = chatMessages.scrollHeight;
                                    }
                                } catch (e) { console.warn('æ— æ³•è§£æçš„æ•°æ®å—:', data); }
                            }
                        }
                    }
                } catch (error) {
                    console.error('API è°ƒç”¨é”™è¯¯:', error);
                    document.getElementById(thinkingId).remove();
                    addMessage(`æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›æŠ€æœ¯é—®é¢˜ï¼Œæš‚æ—¶æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ã€‚`, false);
                }
            }
            function addMessage(content, isUser = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
                const now = new Date();
                const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                const safeContent = isUser ? escapeHtml(content) : content;
                messageDiv.innerHTML = `<div class="message-content">${safeContent}</div><div class="message-time">${timeStr}</div>`;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            function escapeHtml(unsafe) {
                return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }
            chatSendBtn.addEventListener('click', sendMessageToApi);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessageToApi(); });
        })();

        // --- ç”¨æˆ·ç™»å½•éªŒè¯é€»è¾‘ ---
        function checkLogin() {
            const usernameInput = document.getElementById('username-input');
            const passwordInput = document.getElementById('password-input');
            const errorMessage = document.getElementById('login-error');
            const modal = document.getElementById('login-modal');
            const enteredUsername = usernameInput.value.trim();
            const enteredPassword = passwordInput.value.trim();
            if (!enteredUsername || !enteredPassword) {
                errorMessage.textContent = "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼";
                return;
            }
            if (!appConfig || !appConfig.users || !Array.isArray(appConfig.users)) {
                errorMessage.textContent = "ç³»ç»Ÿé…ç½®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼";
                console.error("appConfig.users is not available.");
                return;
            }
            const user = appConfig.users.find(u => u.username === enteredUsername && u.password === enteredPassword);
            if (user) {
                modal.style.opacity = 0;
                setTimeout(() => modal.style.display = 'none', 500);
                errorMessage.textContent = "";
            } else {
                errorMessage.textContent = "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼";
                passwordInput.value = '';
                passwordInput.focus();
                const modalContent = modal.querySelector('.modal-content');
                modalContent.classList.add('shake');
                setTimeout(() => modalContent.classList.remove('shake'), 600);
            }
        }

        document.getElementById('username-input').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') document.getElementById('password-input').focus();
        });
        document.getElementById('password-input').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') checkLogin();
        });

        window.onload = initMap;
    </script>
</body>
</html>